# Kubernetes StatefulSet

Create statefulset

```bash
> kubectl describe statefulset app-python
Name:               app-python
Namespace:          default
CreationTimestamp:  Sat, 09 Dec 2023 18:27:28 +0000
Selector:           app=app-python,app.kubernetes.io/instance=app-python,app.kubernetes.io/managed-by=Helm,app.kubernetes.io/version=1.16.0
Labels:             app=app-python
                    app.kubernetes.io/instance=app-python
                    app.kubernetes.io/managed-by=Helm
                    app.kubernetes.io/version=1.16.0
Annotations:        meta.helm.sh/release-name: app-python
                    meta.helm.sh/release-namespace: default
Replicas:           3 desired | 3 total
Update Strategy:    RollingUpdate
  Partition:        0
Pods Status:        3 Running / 0 Waiting / 0 Succeeded / 0 Failed
Pod Template:
  Labels:  app=app-python
           app.kubernetes.io/instance=app-python
           app.kubernetes.io/managed-by=Helm
           app.kubernetes.io/version=1.16.0
  Containers:
   app-python:
    Image:      ilyasiluyanov/app_python:dev
    Port:       8000/TCP
    Host Port:  0/TCP
    Environment:
      labnofromcm:  <set to the key 'labnofromcm' of config map 'envfromconfigmap'>  Optional: false
    Mounts:
      /app-python/config.json from lab12-config (rw,path="config.json")
      /app_python/volumes from visits-storage (rw)
  Volumes:
   lab12-config:
    Type:      ConfigMap (a volume populated by a ConfigMap)
    Name:      lab12-config
    Optional:  false
   visits-storage:
    Type:       PersistentVolumeClaim (a reference to a PersistentVolumeClaim in the same namespace)
    ClaimName:  visits-pvc
    ReadOnly:   false
Volume Claims:  <none>
Events:
  Type    Reason            Age   From                    Message
  ----    ------            ----  ----                    -------
  Normal  SuccessfulCreate  93s   statefulset-controller  create Pod app-python-0 in StatefulSet app-python successful
  Normal  SuccessfulCreate  86s   statefulset-controller  create Pod app-python-1 in StatefulSet app-python successful
  Normal  SuccessfulCreate  83s   statefulset-controller  create Pod app-python-2 in StatefulSet app-python successful
```


## Provide output

```bash
> kubectl get po,sts,svc,pvc
kubectl get po,sts,svc,pvc                                            
NAME                                        READY   STATUS                       RESTARTS      AGE
pod/app-python-0                            1/1     Running                      0             3m9s
pod/app-python-1                            1/1     Running                      0             3m2s
pod/app-python-2                            1/1     Running                      0             2m59s
pod/app-rust-7bb47887b4-k62g6               0/1     CreateContainerConfigError   0 (10h ago)   29h
pod/vault-0                                 1/1     Running                      3 (10h ago)   13d
pod/vault-agent-injector-576cc6ffc4-m2896   1/1     Running                      3 (10h ago)   13d

NAME                          READY   AGE
statefulset.apps/app-python   3/3     3m9s
statefulset.apps/vault        1/1     13d

NAME                               TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)             AGE
service/app-python                 ClusterIP   10.96.143.18   <none>        80/TCP              32d
service/app-rust                   ClusterIP   10.102.85.85   <none>        80/TCP              32d
service/kubernetes                 ClusterIP   10.96.0.1      <none>        443/TCP             33d
service/vault                      ClusterIP   10.105.114.1   <none>        8200/TCP,8201/TCP   13d
service/vault-agent-injector-svc   ClusterIP   10.106.12.35   <none>        443/TCP             13d
service/vault-internal             ClusterIP   None           <none>        8200/TCP,8201/TCP   13d

NAME                                 STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE
persistentvolumeclaim/data-vault-0   Bound    pvc-d86e01d7-6c2a-4679-bd7b-84f5b948f5c5   10Gi       RWO            standard       13d
persistentvolumeclaim/visits-pvc     Bound    pvc-b40d35c9-98cc-4e46-a4a6-8f3745619c85   100Ki      RWO            standard       25m
```

## Access service

```bash
> kubectl port-forward svc/app-python 8000:80
> kubectl exec app-python-0 -- cat /app_python/volumes/visits
2
> kubectl exec app-python-1 -- cat /app_python/volumes/visits
2
> curl localhost:8000/visits
2
> curl localhost:8000/notes/
[]
> kubectl exec app-python-0 -- cat /app_python/volumes/visits
3
> kubectl exec app-python-1 -- cat /app_python/volumes/visits
3
```

## why ordering guarantees are unnecessary for an app?

Since stateful sets are for distributed systems with state, it might be helpful to update instances sequentially.
For example, when we update an app with a master and replica, we want to update replicas first, then ensure that new version is ready and we can update master

## Implement parallel update

```bash
>  kubectl get po                 
NAME                                    READY   STATUS                       RESTARTS      AGE
app-python-0                            1/1     Running                      0             55s
app-python-1                            1/1     Running                      0             55s
app-python-2                            1/1     Running                      0             55s

> kubectl scale sts/app-python --replicas=10
statefulset.apps/app-python scaled

> kubectl get po
NAME                                    READY   STATUS                       RESTARTS      AGE
app-python-0                            1/1     Running                      0             82s
app-python-1                            1/1     Running                      0             82s
app-python-2                            1/1     Running                      0             82s
app-python-3                            0/1     ContainerCreating            0             5s
app-python-4                            0/1     ContainerCreating            0             5s
app-python-5                            0/1     ContainerCreating            0             5s
app-python-6                            1/1     Running                      0             5s
app-python-7                            1/1     Running                      0             5s
app-python-8                            0/1     ContainerCreating            0             5s
app-python-9                            0/1     ContainerCreating            0             5
```
