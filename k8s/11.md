# Secret management

## Create new secret

```bash
> kubectl get secret
NAME                               TYPE                 DATA   AGE
sh.helm.release.v1.app-python.v1   helm.sh/release.v1   1      19d
sh.helm.release.v1.app-rust.v1     helm.sh/release.v1   1      19d

> kubectl create secret generic lab11-secret --type=string --from-literal=labno=11
secret/lab11-secret created
> kubectl get secret                                                              
NAME                               TYPE                 DATA   AGE
lab11-secret                       string               1      17s
sh.helm.release.v1.app-python.v1   helm.sh/release.v1   1      19d
sh.helm.release.v1.app-rust.v1     helm.sh/release.v1   1      19d
> kubectl get secret lab11-secret -o json | jq '.data[] |= @base64d'
{
  "apiVersion": "v1",
  "data": {
    "labno": "11"
  },
  "kind": "Secret",
  "metadata": {
    "creationTimestamp": "2023-11-26T16:52:28Z",
    "name": "lab11-secret",
    "namespace": "default",
    "resourceVersion": "29617",
    "uid": "2caa4d3a-d8ab-45b3-8613-65d637d4c440"
  },
  "type": "string"
}
```

```bash
> kubectl delete secret lab11-secret                
secret "lab11-secret" deleted
> helm upgrade --values k8s/charts/app-python/values.yaml app-python k8s/charts/app-python
Release "app-python" has been upgraded. Happy Helming!
NAME: app-python
LAST DEPLOYED: Sun Nov 26 17:08:34 2023
NAMESPACE: default
STATUS: deployed
REVISION: 5
TEST SUITE: None
> kubectl get secret lab11-secret -o json | jq '.data[] |= @base64d'
{
  "apiVersion": "v1",
  "data": {
    "labno": "11"
  },
  "kind": "Secret",
  "metadata": {
    "annotations": {
      "meta.helm.sh/release-name": "app-python",
      "meta.helm.sh/release-namespace": "default"
    },
    "creationTimestamp": "2023-11-26T17:08:35Z",
    "labels": {
      "app.kubernetes.io/managed-by": "Helm"
    },
    "name": "lab11-secret",
    "namespace": "default",
    "resourceVersion": "30532",
    "uid": "bc6530f1-010e-4984-b153-3a9c0974f8a4"
  },
  "type": "string"
}

> kubectl get po                                                    
NAME                          READY   STATUS    RESTARTS      AGE
app-python-6bb4d8dd7b-hbvx7   1/1     Running   0             44s
app-python-6bb4d8dd7b-xhzbd   1/1     Running   0             40s
app-python-6bb4d8dd7b-xpvds   1/1     Running   0             42s
app-rust-54745b4ff9-vdj42     1/1     Running   1 (19d ago)   19d
> kubectl exec app-python-6bb4d8dd7b-hbvx7 -- env | grep labno
labno=11
```

## Vault secret management

```bash
> helm install vault ./vault-0.27.0.tgz --set "server.dev.enabled=true"
NAME: vault
LAST DEPLOYED: Sun Nov 26 17:52:02 2023
NAMESPACE: default
STATUS: deployed
REVISION: 1
NOTES:
Thank you for installing HashiCorp Vault!

Now that you have deployed Vault, you should look over the docs on using
Vault with Kubernetes available here:

https://developer.hashicorp.com/vault/docs


Your release is named vault. To learn more about the release, try:

  $ helm status vault
  $ helm get manifest vault

> kubectl get po
kubectl get po
NAME                                    READY   STATUS    RESTARTS      AGE
vault-0                                 1/1     Running   0             27s
vault-agent-injector-576cc6ffc4-m2896   1/1     Running   0             32s

> kubectl exec -it vault-0 -- /bin/sh

> vault secrets enable -path=internal kv-v2
Success! Enabled the kv-v2 secrets engine at: internal/

> vault kv put internal/lab11/secrets labno="11"
======= Secret Path =======
internal/data/lab11/secrets

======= Metadata =======
Key                Value
---                -----
created_time       2023-11-26T18:05:06.131678589Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1

> vault auth enable kubernetes
Success! Enabled kubernetes auth method at: kubernetes/

> vault write auth/kubernetes/config \
>       kubernetes_host="https://$KUBERNETES_PORT_443_TCP_ADDR:443"
Success! Data written to: auth/kubernetes/config

> vault policy write lab11-reader - << EOF
  path "internal/data/lab11/secrets" {
    capabilities = ["read"]
  }
  EOF
Success! Uploaded policy: lab11-reader

> vault write auth/kubernetes/role/lab11-reader \
 bound_service_account_names=lab11-reader \
 bound_service_account_namespaces=default \
 policies=lab11-reader
Success! Data written to: auth/kubernetes/role/lab11-reader

> kubectl create sa lab11-reader
serviceaccount/lab11-reader created
```

```bash
> helm upgrade --values k8s/charts/app-python/values.yaml app-python k8s/charts/app-python
Release "app-python" has been upgraded. Happy Helming!
NAME: app-python
LAST DEPLOYED: Fri Dec  8 11:45:05 2023
NAMESPACE: default
STATUS: deployed
REVISION: 11
TEST SUITE: None
```

```bash
> kubectl exec -ti app-python-7f974cfd85-8s66p -c app-python -- cat /vault/secrets/labno 
data: map[labno:11]
metadata: map[created_time:2023-12-08T11:15:15.005733618Z custom_metadata:<nil> deletion_time: destroyed:false version:1]

> kubectl exec -ti app-python-7f974cfd85-8s66p -c app-python -- df -h /vault/secrets/labno
Filesystem      Size  Used Avail Use% Mounted on
tmpfs           7.8G  4.0K  7.8G   1% /vault/secrets 

```

## Bonus task

### Setup limits

```bash
> kubectl describe deploy app-python
kubectl describe deploy app-python                                                      
Name:                   app-python
Namespace:              default
CreationTimestamp:      Fri, 08 Dec 2023 11:02:50 +0000
Labels:                 app=app-python
                        app.kubernetes.io/instance=app-python
                        app.kubernetes.io/managed-by=Helm
                        app.kubernetes.io/version=1.16.0
Annotations:            deployment.kubernetes.io/revision: 5
                        meta.helm.sh/release-name: app-python
                        meta.helm.sh/release-namespace: default
Selector:               app=app-python,app.kubernetes.io/instance=app-python,app.kubernetes.io/managed-by=Helm,app.kubernetes.io/version=1.16.0
Replicas:               3 desired | 1 updated | 4 total | 3 available | 1 unavailable
StrategyType:           RollingUpdate
MinReadySeconds:        0
RollingUpdateStrategy:  25% max unavailable, 25% max surge
Pod Template:
  Labels:           app=app-python
                    app.kubernetes.io/instance=app-python
                    app.kubernetes.io/managed-by=Helm
                    app.kubernetes.io/version=1.16.0
  Annotations:      kubectl.kubernetes.io/restartedAt: 2023-12-08T11:44:43Z
                    vault.hashicorp.com/agent-inject: true
                    vault.hashicorp.com/agent-inject-secret-labno: internal/lab11/secrets
                    vault.hashicorp.com/agent-inject-status: update
                    vault.hashicorp.com/role: lab11-reader
  Service Account:  lab11-reader
  Containers:
   app-python:
    Image:      ilyasiluyanov/app_python:dev
    Port:       8000/TCP
    Host Port:  0/TCP
    Limits:
      cpu:     250m
      memory:  64Mi
    Requests:
      cpu:     250m
      memory:  64Mi
> helm upgrade --values k8s/charts/app-rust/values.yaml app-rust k8s/charts/app-rust
> kubectl describe deploy app-rust   
Name:                   app-rust
Namespace:              default
CreationTimestamp:      Mon, 06 Nov 2023 20:23:30 +0000
Labels:                 app=app-rust
                        app.kubernetes.io/instance=app-rust
                        app.kubernetes.io/managed-by=Helm
                        app.kubernetes.io/version=1.16.0
Annotations:            deployment.kubernetes.io/revision: 2
                        meta.helm.sh/release-name: app-rust
                        meta.helm.sh/release-namespace: default
Selector:               app=app-rust,app.kubernetes.io/instance=app-rust,app.kubernetes.io/managed-by=Helm,app.kubernetes.io/version=1.16.0
Replicas:               1 desired | 1 updated | 1 total | 1 available | 0 unavailable
StrategyType:           RollingUpdate
MinReadySeconds:        0
RollingUpdateStrategy:  25% max unavailable, 25% max surge
Pod Template:
  Labels:  app=app-rust
           app.kubernetes.io/instance=app-rust
           app.kubernetes.io/managed-by=Helm
           app.kubernetes.io/version=1.16.0
  Containers:
   app-rust:
    Image:      ilyasiluyanov/app_rust:dev
    Port:       8000/TCP
    Host Port:  0/TCP
    Limits:
      cpu:     250m
      memory:  64Mi
    Requests:
      cpu:     250m
      memory:  64Mi
```

### Use named templates

```bash
> kubectl describe deploy app-python
...
    Environment:
      labno:  <set to the key 'labno' in secret 'lab11-secret'>  Optional: false
...
> kubectl describe deploy app-rust
...
    Environment:
      labno:  <set to the key 'labno' in secret 'lab11-secret'>  Optional: false
...
```
